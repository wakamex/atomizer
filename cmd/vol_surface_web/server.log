=== Testing different fixes for flat volatility surface ===

Test 1: Original implementation
Loaded 768 options from CSV
Calculating implied volatilities...
Calculated implied volatilities for 199 options
Cleaning option data...

ðŸ“Š Data Quality Report
Total options: 768
Filtered options: 96 (12.5% kept)

Filtered out:
  - Expired: 150
  - Bad prices: 17
  - Wide spreads: 221
  - Low liquidity: 127
  - IV outliers: 157
Fitting volatility surfaces...
Using 96 options for SVI fitting (from 96 cleaned)
Preprocessed data IV range: 31.7% - 249.3%, avg: 143.4%
Moneyness distribution:
  0.8-0.95: 16 options
  0.95-1.05 (ATM): 11 options
  1.05-1.2: 10 options
  >1.2: 23 options
  <0.8: 36 options
Attempting SSVI (Surface SVI) fitting...
SSVI: ATM vol: 196.16%, Short-term vol: 205.05%, Long-term vol: 121.90%
SSVI: Term structure ratio: 1.682, Initial params: Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Initial params: Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Iter 0: Error=0.128431, Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Iter 500: Error=0.112285, Theta=4.2192, Rho=-0.3680, Phi=1.0664
SSVI Iter 1000: Error=0.103494, Theta=4.1026, Rho=-0.3078, Phi=1.0244
SSVI Iter 1500: Error=0.098101, Theta=4.0106, Rho=-0.2709, Phi=0.9974
SSVI Iter 2000: Error=0.094500, Theta=3.9362, Rho=-0.2484, Phi=0.9789
SSVI Iter 2500: Error=0.091937, Theta=3.8749, Rho=-0.2351, Phi=0.9659
SSVI Iter 3000: Error=0.090024, Theta=3.8236, Rho=-0.2278, Phi=0.9565
SSVI Iter 3500: Error=0.088541, Theta=3.7803, Rho=-0.2245, Phi=0.9495
SSVI Iter 4000: Error=0.087359, Theta=3.7432, Rho=-0.2237, Phi=0.9442
SSVI Iter 4500: Error=0.086394, Theta=3.7113, Rho=-0.2246, Phi=0.9403
SSVI Iter 5000: Error=0.085592, Theta=3.6837, Rho=-0.2267, Phi=0.9372
SSVI Iter 5500: Error=0.084917, Theta=3.6597, Rho=-0.2293, Phi=0.9349
SSVI Iter 6000: Error=0.084341, Theta=3.6386, Rho=-0.2324, Phi=0.9332
SSVI Iter 6500: Error=0.083846, Theta=3.6202, Rho=-0.2356, Phi=0.9318
SSVI Iter 7000: Error=0.083417, Theta=3.6039, Rho=-0.2389, Phi=0.9308
SSVI Iter 7500: Error=0.083043, Theta=3.5895, Rho=-0.2422, Phi=0.9300
âœ… SSVI fitted successfully: Theta=3.5767, Rho=-0.2453, Phi=0.9294
Fitting slice-by-slice SVI with regularization...
Fitted SVI surface with 8 expiry slices
  Expiry 0.018: A=0.0091, B=0.2000, Rho=-0.3000, M=0.0000, Sigma=0.3000
  Expiry 0.037: A=0.0697, B=0.3806, Rho=-0.2568, M=-0.5356, Sigma=0.2212
  Expiry 0.056: A=0.1361, B=0.4916, Rho=-0.1983, M=-0.5743, Sigma=0.1161
  Expiry 0.094: A=0.2409, B=0.6122, Rho=-0.0889, M=-0.5842, Sigma=0.1048
  Expiry 0.171: A=0.5596, B=0.1907, Rho=-0.2310, M=-0.2531, Sigma=0.2707
  Expiry 0.344: A=1.1803, B=0.6281, Rho=-0.5094, M=0.5972, Sigma=0.1512
  Expiry 0.593: A=2.1385, B=0.3851, Rho=-0.5967, M=0.8560, Sigma=0.5747
  Expiry 0.842: A=3.1891, B=0.8559, Rho=-0.6517, M=0.2862, Sigma=0.2424
SSVI GetIV: strike=1750, tte=0.010 -> IV=2.1035
Original: IV range 183.3% - 212.2% (spread: 28.8%)
  SSVI params: Theta=3.5767, Rho=-0.2453, Phi=0.9294

Test 2: Skip aggressive preprocessing
Loaded 768 options from CSV
Calculating implied volatilities...
Calculated implied volatilities for 199 options
Cleaning option data...

ðŸ“Š Data Quality Report
Total options: 768
Filtered options: 96 (12.5% kept)

Filtered out:
  - Expired: 150
  - Bad prices: 17
  - Wide spreads: 221
  - Low liquidity: 127
  - IV outliers: 157
  Using 96 options (vs 92 after preprocessing)
SSVI: ATM vol: 196.16%, Short-term vol: 205.05%, Long-term vol: 121.90%
SSVI: Term structure ratio: 1.682, Initial params: Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Initial params: Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Iter 0: Error=0.128431, Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Iter 500: Error=0.112285, Theta=4.2192, Rho=-0.3680, Phi=1.0664
SSVI Iter 1000: Error=0.103494, Theta=4.1026, Rho=-0.3078, Phi=1.0244
SSVI Iter 1500: Error=0.098101, Theta=4.0106, Rho=-0.2709, Phi=0.9974
SSVI Iter 2000: Error=0.094500, Theta=3.9362, Rho=-0.2484, Phi=0.9789
SSVI Iter 2500: Error=0.091937, Theta=3.8749, Rho=-0.2351, Phi=0.9659
SSVI Iter 3000: Error=0.090024, Theta=3.8236, Rho=-0.2278, Phi=0.9565
SSVI Iter 3500: Error=0.088541, Theta=3.7803, Rho=-0.2245, Phi=0.9495
SSVI Iter 4000: Error=0.087359, Theta=3.7432, Rho=-0.2237, Phi=0.9442
SSVI Iter 4500: Error=0.086394, Theta=3.7113, Rho=-0.2246, Phi=0.9403
SSVI Iter 5000: Error=0.085592, Theta=3.6837, Rho=-0.2267, Phi=0.9372
SSVI Iter 5500: Error=0.084917, Theta=3.6597, Rho=-0.2293, Phi=0.9349
SSVI Iter 6000: Error=0.084341, Theta=3.6386, Rho=-0.2324, Phi=0.9332
SSVI Iter 6500: Error=0.083846, Theta=3.6202, Rho=-0.2356, Phi=0.9318
SSVI Iter 7000: Error=0.083417, Theta=3.6039, Rho=-0.2389, Phi=0.9308
SSVI Iter 7500: Error=0.083043, Theta=3.5895, Rho=-0.2422, Phi=0.9300
SSVI GetIV: strike=1750, tte=0.010 -> IV=2.1035
No preprocessing: IV range 183.3% - 212.2% (spread: 28.8%)
  SSVI params: Theta=3.5767, Rho=-0.2453, Phi=0.9294

Test 3: Better SSVI initial parameters (higher Phi)
Loaded 768 options from CSV
Calculating implied volatilities...
Calculated implied volatilities for 199 options
Cleaning option data...

ðŸ“Š Data Quality Report
Total options: 768
Filtered options: 96 (12.5% kept)

Filtered out:
  - Expired: 150
  - Bad prices: 17
  - Wide spreads: 221
  - Low liquidity: 127
  - IV outliers: 157
SSVI GetIV: strike=1750, tte=0.010 -> IV=2.1576
High initial Phi=0.8: IV range 186.6% - 217.4% (spread: 30.8%)
  SSVI params: Theta=3.8158, Rho=-0.2962, Phi=0.7944

Test 4: Minimum Phi constraint
Loaded 768 options from CSV
Calculating implied volatilities...
Calculated implied volatilities for 199 options
Cleaning option data...

ðŸ“Š Data Quality Report
Total options: 768
Filtered options: 96 (12.5% kept)

Filtered out:
  - Expired: 150
  - Bad prices: 17
  - Wide spreads: 221
  - Low liquidity: 127
  - IV outliers: 157
SSVI GetIV: strike=1750, tte=0.010 -> IV=2.0254
Min Phi=0.3: IV range 190.4% - 203.1% (spread: 12.7%)
  SSVI params: Theta=3.8251, Rho=-0.3023, Phi=0.3015

Test 5: SVI only (no SSVI)
Loaded 768 options from CSV
Calculating implied volatilities...
Calculated implied volatilities for 199 options
Cleaning option data...

ðŸ“Š Data Quality Report
Total options: 768
Filtered options: 96 (12.5% kept)

Filtered out:
  - Expired: 150
  - Bad prices: 17
  - Wide spreads: 221
  - Low liquidity: 127
  - IV outliers: 157
Fitting volatility surfaces...
Using 96 options for SVI fitting (from 96 cleaned)
Preprocessed data IV range: 31.7% - 249.3%, avg: 143.4%
Moneyness distribution:
  0.95-1.05 (ATM): 11 options
  1.05-1.2: 10 options
  >1.2: 23 options
  <0.8: 36 options
  0.8-0.95: 16 options
Attempting SSVI (Surface SVI) fitting...
SSVI: ATM vol: 196.16%, Short-term vol: 205.05%, Long-term vol: 121.90%
SSVI: Term structure ratio: 1.682, Initial params: Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Initial params: Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Iter 0: Error=0.128431, Theta=4.3727, Rho=-0.4682, Phi=1.1364
SSVI Iter 500: Error=0.112285, Theta=4.2192, Rho=-0.3680, Phi=1.0664
SSVI Iter 1000: Error=0.103494, Theta=4.1026, Rho=-0.3078, Phi=1.0244
SSVI Iter 1500: Error=0.098101, Theta=4.0106, Rho=-0.2709, Phi=0.9974
SSVI Iter 2000: Error=0.094500, Theta=3.9362, Rho=-0.2484, Phi=0.9789
SSVI Iter 2500: Error=0.091937, Theta=3.8749, Rho=-0.2351, Phi=0.9659
SSVI Iter 3000: Error=0.090024, Theta=3.8236, Rho=-0.2278, Phi=0.9565
SSVI Iter 3500: Error=0.088541, Theta=3.7803, Rho=-0.2245, Phi=0.9495
SSVI Iter 4000: Error=0.087359, Theta=3.7432, Rho=-0.2237, Phi=0.9442
SSVI Iter 4500: Error=0.086394, Theta=3.7113, Rho=-0.2246, Phi=0.9403
SSVI Iter 5000: Error=0.085592, Theta=3.6837, Rho=-0.2267, Phi=0.9372
SSVI Iter 5500: Error=0.084917, Theta=3.6597, Rho=-0.2293, Phi=0.9349
SSVI Iter 6000: Error=0.084341, Theta=3.6386, Rho=-0.2324, Phi=0.9332
SSVI Iter 6500: Error=0.083846, Theta=3.6202, Rho=-0.2356, Phi=0.9318
SSVI Iter 7000: Error=0.083417, Theta=3.6039, Rho=-0.2389, Phi=0.9308
SSVI Iter 7500: Error=0.083043, Theta=3.5895, Rho=-0.2422, Phi=0.9300
âœ… SSVI fitted successfully: Theta=3.5767, Rho=-0.2453, Phi=0.9294
Fitting slice-by-slice SVI with regularization...
Fitted SVI surface with 8 expiry slices
  Expiry 0.018: A=0.0091, B=0.2000, Rho=-0.3000, M=0.0000, Sigma=0.3000
  Expiry 0.037: A=0.0697, B=0.3806, Rho=-0.2568, M=-0.5356, Sigma=0.2212
  Expiry 0.056: A=0.1361, B=0.4916, Rho=-0.1983, M=-0.5743, Sigma=0.1161
  Expiry 0.094: A=0.2409, B=0.6122, Rho=-0.0889, M=-0.5842, Sigma=0.1048
  Expiry 0.171: A=0.5596, B=0.1907, Rho=-0.2310, M=-0.2531, Sigma=0.2707
  Expiry 0.344: A=1.1803, B=0.6281, Rho=-0.5094, M=0.5972, Sigma=0.1512
  Expiry 0.593: A=2.1385, B=0.3851, Rho=-0.5967, M=0.8560, Sigma=0.5747
  Expiry 0.842: A=3.1891, B=0.8559, Rho=-0.6517, M=0.2862, Sigma=0.2424
SVI only: IV range 184.0% - 337.7% (spread: 153.7%)

Test 6: Data distribution analysis
  Strike distribution:
    ATM (0.9-1.1): 20 options
    OTM Call (1.1-1.3): 18 options
    Deep OTM Call (>1.3): 11 options
    Deep OTM Put (<0.7): 16 options
    OTM Put (0.7-0.9): 31 options
